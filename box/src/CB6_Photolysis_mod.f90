module CB6_Photolysis
 implicit none
 private

 integer, parameter, private :: NTAB = 53, NJ=302, NZEN = 11
 integer, dimension(NZEN), &
      parameter, private :: zens = [ 0,10,20,30,40,50,60,70,78,86,90 ]

 public :: cb6photol
 public :: init_cb6photol

 ! We store the tabulated data from Greg Yarwood here:
 ! A little wasteful, but we keep the array big: 302 rows
 type, private :: jj
   real, dimension(NZEN) :: jz       ! rates at different zenith angles
   character(len=30)     :: reaction = '-'  ! e.g. NO2->
 end type jj

  type(jj), dimension(NJ), private, save :: djTab

contains

!-----------------------------------------------------------------------------
  subroutine init_cb6photol()
   
    ! Initialise for: zens = [ 0,10,20,30,40,50,60,70,78,86,90 ]
    ! Units: s-1
    !----------------------------------------------------------------------!
     djTab(  1)=jj([0.101E-01,0.999E-02,0.977E-02,0.938E-02,0.875E-02,&
                    0.777E-02,0.630E-02,0.415E-02,0.209E-02,0.512E-03,0.0],&
                    "NO2")
     djTab(  8)=jj([0.426E-03,0.424E-03,0.419E-03,0.410E-03,0.394E-03,&
                    0.371E-03,0.333E-03,0.269E-03,0.179E-03,0.427E-04,0.0],&
                    "O3->O")
     djTab(  9)=jj([0.455E-04,0.441E-04,0.399E-04,0.335E-04,0.254E-04,&
                    0.167E-04,0.878E-05,0.317E-05,0.920E-06,0.152E-06,0.0],&
                    "O3->O1D")
     djTab( 21)=jj([0.879E-05,0.866E-05,0.826E-05,0.760E-05,0.664E-05,&
                    0.535E-05,0.377E-05,0.205E-05,0.881E-06,0.203E-06,0.0],&
                    "H2O2->2 OH")
     djTab( 27)=jj([0.188,0.188,0.186,0.183,0.179,&
                    0.171,0.156,0.126,0.822E-01,0.179E-01,0.0],&
                    "NO3->NO2+O")
     djTab( 28)=jj([0.232E-01,0.232E-01,0.231E-01,0.228E-01,0.223E-01,&
                    0.214E-01,0.198E-01,0.164E-01,0.112E-01,0.263E-02,0.0],&
                    "NO3->NO")
     djTab( 38)=jj([0.554E-04,0.546E-04,0.523E-04,0.484E-04,0.426E-04,&
                    0.348E-04,0.252E-04,0.142E-04,0.630E-05,0.148E-05,0.0],&
                    "N2O5->NO2+NO3")
     djTab( 43)=jj([0.174E-02,0.172E-02,0.168E-02,0.161E-02,0.149E-02,&
                    0.131E-02,0.104E-02,0.669E-03,0.329E-03,0.835E-04,0.0],&
                    "-")
     djTab( 47)=jj([0.847E-06,0.828E-06,0.770E-06,0.680E-06,0.556E-06,&
                    0.409E-06,0.254E-06,0.116E-06,0.420E-07,0.800E-08,0.0],&
                    "-")
     djTab( 50)=jj([0.702E-05,0.688E-05,0.646E-05,0.578E-05,0.484E-05,&
                    0.366E-05,0.236E-05,0.112E-05,0.416E-06,0.773E-07,0.0],&
                    "PNA(=HO2NO2)->")
     djTab( 56)=jj([0.953E-06,0.935E-06,0.881E-06,0.794E-06,0.672E-06,&
                    0.519E-06,0.346E-06,0.175E-06,0.705E-07,0.152E-07,0.0],&
                    "PAN")
     djTab( 88)=jj([0.602E-05,0.594E-05,0.568E-05,0.524E-05,0.460E-05,&
                    0.375E-05,0.268E-05,0.149E-05,0.652E-06,0.153E-06,0.0],&
                    "-")
     djTab( 92)=jj([0.329E-05,0.322E-05,0.301E-05,0.268E-05,0.222E-05,&
                    0.166E-05,0.106E-05,0.498E-06,0.185E-06,0.360E-07,0.0],&
                    "NTR1->NO2")
     djTab( 97)=jj([0.434E-04,0.428E-04,0.408E-04,0.374E-04,0.324E-04,&
                    0.258E-04,0.178E-04,0.929E-05,0.378E-05,0.790E-06,0.0],&
                    "-")
     djTab( 98)=jj([0.485E-04,0.480E-04,0.462E-04,0.432E-04,0.387E-04,&
                    0.323E-04,0.238E-04,0.137E-04,0.619E-05,0.151E-05,0.0],&
                    "-")
     djTab(108)=jj([0.651E-05,0.636E-05,0.589E-05,0.516E-05,0.416E-05,&
                    0.298E-05,0.176E-05,0.729E-06,0.230E-06,0.357E-07,0.0],&
                    "ALD2")
     djTab(112)=jj([0.220E-04,0.215E-04,0.201E-04,0.179E-04,0.148E-04,&
                    0.110E-04,0.696E-05,0.320E-05,0.115E-05,0.210E-06,0.0],&
                    "ALDX")
     djTab(114)=jj([0.613E-05,0.598E-05,0.551E-05,0.478E-05,0.381E-05,&
                    0.269E-05,0.156E-05,0.643E-06,0.206E-06,0.339E-07,0.0],&
                    "GLYD")
     djTab(117)=jj([0.913E-04,0.906E-04,0.884E-04,0.845E-04,0.782E-04,&
                    0.687E-04,0.550E-04,0.358E-04,0.178E-04,0.428E-05,0.0],&
                    "GLY")
     djTab(119)=jj([0.236E-03,0.235E-03,0.229E-03,0.219E-03,0.204E-03,&
                    0.180E-03,0.146E-03,0.967E-04,0.492E-04,0.116E-04,0.0],&
                    "MYGL->")
     djTab(128)=jj([0.116E-05,0.112E-05,0.102E-05,0.855E-06,0.650E-06,&
                    0.428E-06,0.226E-06,0.820E-07,0.234E-07,0.359E-08,0.0],&
                    "KET")
     djTab(129)=jj([0.102E-05,0.994E-06,0.902E-06,0.762E-06,0.583E-06,&
                    0.388E-06,0.208E-06,0.770E-07,0.225E-07,0.351E-08,0.0],&
                    "ACET->")
     djTab(161)=jj([0.296E-04,0.293E-04,0.284E-04,0.269E-04,0.245E-04,&
                    0.209E-04,0.160E-04,0.975E-05,0.460E-05,0.116E-05,0.0],&
                    "ISPD")
     djTab( 64)=jj([0.953E-06,0.935E-06,0.881E-06,0.794E-06,0.672E-06,&
                    0.519E-06,0.346E-06,0.175E-06,0.705E-07,0.152E-07,0.0],&
                    "PANX")
     djTab( 90)=jj([0.602E-05,0.594E-05,0.568E-05,0.524E-05,0.460E-05,&
                    0.375E-05,0.268E-05,0.149E-05,0.652E-06,0.153E-06,0.0],&
                    "ROOH->HO2+OH")
     djTab(163)=jj([0.704E-03,0.699E-03,0.684E-03,0.657E-03,0.612E-03,&
                    0.544E-03,0.441E-03,0.291E-03,0.146E-03,0.358E-04,0.0],&
                    "HPLD:hydroperoxyaldehyde")
     djTab(196)=jj([0.151E-03,0.150E-03,0.147E-03,0.141E-03,0.131E-03,&
                    0.116E-03,0.945E-04,0.623E-04,0.313E-04,0.768E-05,0.0],&
                    "CRON")
     djTab(197)=jj([0.804E-03,0.799E-03,0.782E-03,0.751E-03,0.700E-03,&
                    0.621E-03,0.504E-03,0.332E-03,0.167E-03,0.409E-04,0.0],&
                    "XOPN")
     djTab(201)=jj([0.804E-03,0.799E-03,0.782E-03,0.751E-03,0.700E-03,&
                    0.621E-03,0.504E-03,0.332E-03,0.167E-03,0.409E-04,0.0],&
                    "-")
     djTab(217)=jj([0.248E-02,0.247E-02,0.241E-02,0.232E-02,0.216E-02,&
                    0.192E-02,0.156E-02,0.103E-02,0.516E-03,0.126E-03,0.0],&
                    "-")
     djTab(218)=jj([0.273E-03,0.269E-03,0.260E-03,0.243E-03,0.217E-03,&
                    0.181E-03,0.134E-03,0.770E-04,0.348E-04,0.846E-05,0.0],&
                    "-")
     djTab(225)=jj([0.121E-04,0.119E-04,0.114E-04,0.104E-04,0.904E-05,&
                    0.720E-05,0.497E-05,0.259E-05,0.105E-05,0.220E-06,0.0],&
                    "-")
     djTab(226)=jj([0.861E-03,0.854E-03,0.827E-03,0.783E-03,0.712E-03,&
                    0.609E-03,0.467E-03,0.284E-03,0.134E-03,0.337E-04,0.0],&
                    "-")
     djTab(230)=jj([0.226E-06,0.221E-06,0.204E-06,0.179E-06,0.144E-06,&
                    0.103E-06,0.610E-07,0.253E-07,0.800E-08,0.124E-08,0.0],&
                    "-")
     djTab(238)=jj([0.582E-03,0.575E-03,0.555E-03,0.519E-03,0.464E-03,&
                    0.387E-03,0.286E-03,0.164E-03,0.742E-04,0.181E-04,0.0],&
                    "-")
     djTab(239)=jj([0.372E-01,0.371E-01,0.369E-01,0.363E-01,0.354E-01,&
                    0.338E-01,0.308E-01,0.250E-01,0.163E-01,0.355E-02,0.0],&
                    "-")
     djTab(240)=jj([0.241E-02,0.240E-02,0.234E-02,0.225E-02,0.210E-02,&
                    0.186E-02,0.151E-02,0.997E-03,0.501E-03,0.123E-03,0.0],&
                    "-")
     djTab(247)=jj([0.417E-01,0.412E-01,0.397E-01,0.372E-01,0.333E-01,&
                    0.277E-01,0.205E-01,0.118E-01,0.532E-02,0.130E-02,0.0],&
                    "-")
     djTab(254)=jj([0.513E-02,0.509E-02,0.498E-02,0.479E-02,0.446E-02,&
                    0.396E-02,0.321E-02,0.212E-02,0.107E-02,0.261E-03,0.0],&
                    "-")
     djTab(255)=jj([0.156E-02,0.155E-02,0.151E-02,0.145E-02,0.136E-02,&
                    0.120E-02,0.976E-03,0.644E-03,0.324E-03,0.793E-04,0.0],&
                    "-")
     djTab(258)=jj([0.154E-04,0.150E-04,0.139E-04,0.122E-04,0.982E-05,&
                    0.702E-05,0.415E-05,0.172E-05,0.544E-06,0.842E-07,0.0],&
                    "-")
     djTab(264)=jj([0.173,0.173,0.172,0.169,0.165,&
                    0.157,0.144,0.116,0.758E-01,0.165E-01,0.0],&
                    "-")
     djTab(265)=jj([0.102,0.101,0.987E-01,0.948E-01,0.884E-01,&
                    0.784E-01,0.636E-01,0.419E-01,0.211E-01,0.517E-02,0.0],&
                    "-")
     djTab(272)=jj([0.188,0.187,0.183,0.175,0.164,&
                    0.145,0.118,0.777E-01,0.391E-01,0.957E-02,0.0],&
                    "-")
     djTab(278)=jj([0.171,0.170,0.169,0.167,0.162,&
                    0.155,0.141,0.115,0.746E-01,0.163E-01,0.0],&
                    "-")
     djTab(285)=jj([0.513E-02,0.509E-02,0.498E-02,0.479E-02,0.446E-02,&
                    0.396E-02,0.321E-02,0.212E-02,0.107E-02,0.261E-03,0.0],&
                    "-")
     djTab(287)=jj([0.254E-01,0.251E-01,0.242E-01,0.226E-01,0.202E-01,&
                    0.169E-01,0.125E-01,0.717E-02,0.323E-02,0.788E-03,0.0],&
                    "-")
     djTab(292)=jj([0.778E-05,0.766E-05,0.729E-05,0.669E-05,0.580E-05,&
                    0.462E-05,0.319E-05,0.166E-05,0.677E-06,0.141E-06,0.0],&
                    "-")
     djTab(293)=jj([0.955E-02,0.945E-02,0.910E-02,0.852E-02,0.762E-02,&
                    0.636E-02,0.469E-02,0.270E-02,0.122E-02,0.297E-03,0.0],&
                    "-")
     djTab(294)=jj([0.617E-03,0.608E-03,0.579E-03,0.531E-03,0.460E-03,&
                    0.366E-03,0.253E-03,0.132E-03,0.537E-04,0.112E-04,0.0],&
                    "-")
     djTab(295)=jj([0.182E-03,0.180E-03,0.171E-03,0.157E-03,0.136E-03,&
                    0.108E-03,0.748E-04,0.390E-04,0.159E-04,0.332E-05,0.0],&
                    "-")
     djTab(296)=jj([0.172E-05,0.168E-05,0.155E-05,0.136E-05,0.110E-05,&
                    0.786E-06,0.464E-06,0.192E-06,0.608E-07,0.942E-08,0.0],&
                    "-")
     djTab(302)=jj([0.196E-05,0.191E-05,0.178E-05,0.157E-05,0.129E-05,&
                    0.945E-06,0.588E-06,0.268E-06,0.970E-07,0.184E-07,0.0],&
                    "-")
    !----------------------------------------------------------------------!


  end subroutine init_cb6photol

!-----------------------------------------------------------------------------

  elemental function cb6photol(id,Zen) result(J)
    integer, intent(in) :: id  ! Index of CB6 photol (can be indices)
    real, intent(in) :: Zen  ! factor compared to J(NO2)
    real :: J, dz
    integer :: izen, iz1, iz2

    iz1=1
    do izen = 2, NZEN-1  ! 10, 20, ..86
      if ( Zen < zens(izen)) exit
      iz1 = iz1 + 1
    end do 
    iz2 = iz1 + 1

    dz = ( Zen-zens(iz1)  )/(zens(iz2)-zens(iz1))
    J =  (1-dz)* djTab(id)%jz(iz1)+ dz*djTab(id)%jz(iz2)

!if( id==1) then
!    print "(a,4i3,f8.3,3es11.3)", "Zen ", iz1, iz2, zens(iz1), zens(iz2), &
!        dz, djTab(id)%jz(iz1), djTab(id)%jz(iz2), J
! if( iz2==NZEN)   stop 'IZEN'
!end if
     
  end function cb6photol
!-----------------------------------------------------------------------------
end module CB6_Photolysis
  
!TSTEMX program testr
!TSTEMX   use CB6_Photolysis
!TSTEMX   call init_cb6photol()
!TSTEMX   print *, "0.1 deg, ", cb6photol(8,0.1)
!TSTEMX   print *, "45  deg, ", cb6photol(8,45.0)
!TSTEMX   print *, "45  deg, 1,8,296 ", cb6photol([ 1, 8, 296], 45.)
!TSTEMX   !    fNO2 = Jcb6tab(id,1)/Jcb6tab(1,1) ! NO2 is id=1
!TSTEMX   print *, "HO2NO2?"
!TSTEMX   print *, "45  deg, 1,50,296 ", cb6photol([ 1, 50, 296], 45.)
!TSTEMX end program testr
